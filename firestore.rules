/**
 * This ruleset implements a multi-tenant security model for a hospital pharmacy application.
 *
 * Core Philosophy:
 * - All access requires authentication.
 * - A user's access is primarily scoped to the hospital they belong to.
 * - A user's hospital affiliation is stored in a `UserProfile` document in the `/users` collection.
 * - Most data is stored in subcollections under `/hospitals/{hospitalId}`.
 * - The `/transfers` collection is a root collection but access is controlled based on the
 *   `fromHospitalId` and `toHospitalId` fields within each transfer document.
 *
 * Data Structure:
 * - /hospitals/{hospitalId}: Stores public information about each hospital.
 * - /users/{userId}: Stores a user profile, including their `hospitalId`. This is the link between a user and their data.
 * - /hospitals/{hospitalId}/drugs/{drugId}: Inventory for a specific hospital.
 * - /hospitals/{hospitalId}/services/{serviceId}: Departments within a specific hospital.
 * - /hospitals/{hospitalId}/distributions/{distributionId}: Internal distribution records for a hospital.
 * - /transfers/{transferId}: Records for medication transfers between hospitals.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    /**
     * isSignedIn
     * Checks if the user making the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * getUserProfile
     * Retrieves the profile document for the currently authenticated user.
     */
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    /**
     * isUserOfHospital
     * Checks if the currently authenticated user belongs to the specified hospital.
     */
    function isUserOfHospital(hospitalId) {
      let userProfile = getUserProfile();
      return userProfile.data.hospitalId == hospitalId;
    }

    // --------------------------------
    // Collection Rules
    // --------------------------------

    /**
     * @description Public information about hospitals. Any authenticated user can read this list
     *              to know about other hospitals for transfers. Writing is restricted.
     * @path /hospitals/{hospitalId}
     */
    match /hospitals/{hospitalId} {
      allow get, list: if isSignedIn();
      allow write: if false; // Should be managed by an admin role in a real app
    }
    
    /**
     * @description User profile data. A user can read and update their own profile.
     *              No one else can read or write to it.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get, update: if isSignedIn() && request.auth.uid == userId;
      allow create, delete: if false; // Profile creation handled by backend logic or seeded
    }

    /**
     * @description Generic rule for all data nested under a specific hospital.
     *              This ensures that all operations within a hospital's data silo
     *              are only performed by users belonging to that hospital.
     * @path /hospitals/{hospitalId}
     */
    match /hospitals/{hospitalId}/{documents=**} {
       allow read, write: if isSignedIn() && isUserOfHospital(hospitalId);
    }
    
    /**
     * @description Specific rules for the drug inventory of a hospital.
     *              Inherits the hospital-level check from the rule above.
     *              Allows create, update, but prevents deletion to preserve history.
     * @path /hospitals/{hospitalId}/drugs/{drugId}
     */
    match /hospitals/{hospitalId}/drugs/{drugId} {
      // isUserOfHospital check is implicitly applied from the parent match
      allow get, list, create, update: if isSignedIn() && isUserOfHospital(hospitalId);
      allow delete: if false;
    }
    
     /**
     * @description Specific rules for internal service distributions.
     *              Inherits the hospital-level check. Allows creation of new
     *              distribution records but makes them immutable afterwards.
     * @path /hospitals/{hospitalId}/distributions/{distributionId}
     */
    match /hospitals/{hospitalId}/distributions/{distributionId} {
      allow get, list, create: if isSignedIn() && isUserOfHospital(hospitalId);
      allow update, delete: if false;
    }
    
    /**
     * @description Rules for managing a hospital's internal services/departments.
     *              Inherits the hospital-level check. Allows full CRUD.
     * @path /hospitals/{hospitalId}/services/{serviceId}
     */
    match /hospitals/{hospitalId}/services/{serviceId} {
       allow read, write: if isSignedIn() && isUserOfHospital(hospitalId);
    }

    /**
     * @description Manages access to inter-hospital transfer records. This is a root collection.
     * @path /transfers/{transferId}
     */
    match /transfers/{transferId} {
      /**
       * Read access is granted if the user's hospital is either the sender or the receiver.
       */
      allow get, list: if isSignedIn() && 
                      (isUserOfHospital(resource.data.fromHospitalId) || isUserOfHospital(resource.data.toHospitalId));
      
      /**
       * A transfer can be created if the user belongs to the sending hospital and the
       * request body correctly identifies them as the creator.
       */
      allow create: if isSignedIn() && 
                     isUserOfHospital(request.resource.data.fromHospitalId) &&
                     request.auth.uid == request.resource.data.createdByUserId;

      /**
       * A transfer can be updated (e.g., to be marked as 'completed' or 'rejected')
       * if the user belongs to the receiving hospital and the transfer is still 'pending'.
       */
      allow update: if isSignedIn() && 
                     isUserOfHospital(request.resource.data.toHospitalId) &&
                     resource.data.status == 'pending';
                     
      allow delete: if false; // Transfers should not be deleted, only marked as 'cancelled' or 'rejected'.
    }
  }
}
