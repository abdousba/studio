/**
 * Core Philosophy: This ruleset allows any authenticated application user (including those signed in anonymously)
 * to read all data and to write data necessary for the application's core functions. The goal is to
 * enable the prototype's features (inventory management, distribution tracking) while still requiring
 * authentication for all actions.
 *
 * Data Structure: The data is organized into three distinct, top-level collections:
 * - /drugs/{barcode}: Stores all drug inventory information.
 * - /distributions/{id}: Records every instance of a drug being distributed to a hospital service.
 * - /services/{id}: A reference collection listing the hospital's services or departments.
 *
 * Key Security Decisions:
 * - Authenticated CRUD: All authenticated users can create, read, and update the data required for the app to function.
 *   Destructive operations like deleting drugs are restricted to prevent accidental data loss in this prototype stage.
 * - Anonymous Users Treated as Authenticated: The rules do not distinguish between users signed in with a
 *   password and those signed in anonymously. Both are granted the same permissions for prototyping purposes.
 *
 * Denormalization for Authorization: The schema design correctly denormalizes the `itemName` onto each
 * distribution record. This design is a best practice that simplifies security rules by avoiding costly `get()` calls.
 *
 * Structural Segregation: The use of separate top-level collections for `drugs`, `distributions`, and `services`
 * is a core architectural strength. It allows for clear, independent, and performant security rules for each
 * distinct data entity without overlap or confusion.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    /**
     * isSignedIn
     * Checks if the user making the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    // --------------------------------
    // Collection Rules
    // --------------------------------

    /**
     * @description Controls access to the drug inventory. Allows authenticated users to read, create, and update
     *              drug information to manage stock levels. Deletion is disallowed to prevent accidental data loss.
     * @path /drugs/{barcode}
     * @allow An authenticated user updates the stock of a drug after a distribution. (update)
     * @deny An anonymous user attempts to delete a drug. (delete)
     * @principle Enable core inventory management functions for authenticated users while protecting against data deletion.
     */
    match /drugs/{barcode} {
      allow get, list: if isSignedIn();
      allow create, update: if isSignedIn();
      allow delete: if false;
    }

    /**
     * @description Manages access to drug distribution records. Authenticated users can create new records when
     *              distributing medication. Reading is allowed to view history. Updates and deletes are disallowed.
     * @path /distributions/{id}
     * @allow An authenticated user creates a new distribution record. (create)
     * @deny An authenticated user tries to update a past distribution record. (update)
     * @principle Enable logging of new distributions while making historical records immutable.
     */
    match /distributions/{id} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Secures the collection of hospital services/departments. This is reference data that can
     *              be fully managed (created, read, updated, deleted) by any authenticated user for this prototype.
     * @path /services/{id}
     * @allow An authenticated user adds a new hospital service. (create)
     * @allow An authenticated user deletes an obsolete service. (delete)
     * @principle Provide full control over service reference data for authenticated users.
     */
    match /services/{id} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }
  }
}
